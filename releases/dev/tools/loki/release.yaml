apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: loki
  namespace: internal
spec:
  releaseName: loki
  interval: 5m
  chart:
    spec:
      chart: loki
      sourceRef:
        kind: HelmRepository
        name: grafana
        namespace: flux-system
      version: "6.27.0"
  values:
    global:
      imagePullSecrets: []
      clusterDomain: "cluster.local"

    # Use the simplest deployment mode for testing.
    deploymentMode: SingleBinary

    loki:
      image:
        registry: docker.io
        repository: grafana/loki
        tag: "3.4.2"
        pullPolicy: IfNotPresent

      # Disable authentication for testing purposes.
      auth_enabled: false

      # Configure Loki to listen on port 3100.
      server:
        http_listen_port: 3100

      # For quick testing, enable the built-in test schema.
      useTestSchema: true

      # Minimal Loki configuration. (The test schema flag tells the chart to use a built-in test schema.)
      config: |
        auth_enabled: false
        server:
          http_listen_port: 3100
        ingester:
          wal:
            enabled: true
        schema_config:
          configs:
            - from: 2020-10-24
              store: boltdb-shipper
              object_store: filesystem
              schema: v11
              index:
                prefix: index_
                period: 24h
        storage_config:
          boltdb_shipper:
            active_index_directory: /tmp/loki/index
            cache_location: /tmp/loki/cache
            shared_store: filesystem
          filesystem:
            directory: /tmp/loki/chunks

    resources:
      requests:
        cpu: 100m
        memory: 256Mi
      limits:
        cpu: 200m
        memory: 512Mi
    # Persistence is disabled for quick testing.
    persistence:
      enabled: true
      size: 10Gi
    service:
      type: NodePort
      port: 3100         # The port the Service will expose
      targetPort: 3100   # The port Loki listens on within the pod
      nodePort: 30060    # The port on each Node to route traffic to Loki